---
title: 'Analysis: NNK7 Induced set'
output: html_document
date: "2023-01-19"
---

```{r setup, include=FALSE}
# Gets thing set up. Need the library, and some functions.

knitr::opts_chunk$set(echo = TRUE, comment = '', fig.width = 6, fig.height = 6)

library(tidyverse)
library(ggplot2)

source("C:/Users/worms/Dropbox/PhD/PhD-Scripts/CyclicPeptidePipeline/function.R")
```

# Introduction

This is the analysis of the induced NNK7 peptides from the drift experiment. The required datasets are created in the "peptideAnalysis.R" file. I'm going to do it on a subset of 100 000 reads at first to speed things up.


```{r 'load datasets', echo=FALSE}
directory <- "C:/Users/worms/NGS Data/2022.06.07_drift_seq/90-666155004b/00_fastq/NNK/NNK7"
induced_set <- read.csv(file = paste(directory, "induced_set_NNK7.csv", sep = "/"),
                        nrow = 100000) 

```

## Summary

Let's have a look at the distribution of enrichment ration:

```{r echo=TRUE}
summary(induced_set$enrichment_ratio)
```
We can see that in induced conditions, most peptides becomes slightly less common. None are strongly purged and some are highly enriched. I take the large number of peptides with an enrichment ratio of <1 to basically be neutrally selected. Overall out of `r nrow(induced_set)` genes encoding peptides, `r induced_set %>% filter(enrichment_ratio < 1) %>% nrow()` have a enrichment ratio of less than 1, `r induced_set %>% filter(between(enrichment_ratio,1,2)) %>% nrow()` are weakly selected (enrichment ratio of between 1 and 2) and `r induced_set %>% filter(enrichment_ratio > 2) %>% nrow()` (`r induced_set %>% filter(enrichment_ratio > 2) %>% nrow() / nrow(induced_set) * 100`%) have an enrichment ratio of over 2.

```{r, 'graph low enrichment', echo=FALSE}
ggplot(induced_set %>%
         filter(enrichment_ratio < 1.25), aes(enrichment_ratio)) +
  geom_histogram(bins = 30, color = "black", fill = "lightblue") +
  labs(x = "Enrichment Ratio", y = "Frequency") +
  ggtitle("Histogram of the enrichment ratio for enrichment < 1.25")
```

If we look at it taking the log2 of the enrichment ratio, we get the followin graph. There seems to be a relatively uniform distribution of genes with enrichment ratio between 2 and 128.

```{r echo=FALSE}
ggplot(induced_set %>%
         filter(enrichment_ratio_log > 0.5), aes(enrichment_ratio_log)) +
  geom_histogram(bins = 30, color = "black", fill = "lightblue") +
  labs(x = "Log(Enrichment Ratio)", y = "Frequency") +
  ggtitle("Histogram of the enrichment ratio for log(enrichment) > 0.5")
```


This is strange as we expect some toxic peptides. And they don't seem to be many peptides that are purged!

## Peptides with stop codons

```{r echo=FALSE}
induced_set_stops <- induced_set %>%
  filter(grepl("\\*", peptide_seq))
```

I'll now subset the `r nrow(induced_set_stops)` sequences (`r (nrow(induced_set_stops)/nrow(induced_set)*100) %>% round(digits = 2)`% of the total) that contains stop codons. The percentage I would expect with peptides containing 7 randomized NNK codons is `r ((1-(31/32)^7)*100) %>% round(digits = 2)`% of the total, so this is consistent. 

```{r echo=FALSE}
ggplot(induced_set_stops %>%
         filter(enrichment_ratio < 1.25), aes(enrichment_ratio)) +
  geom_histogram(bins = 30, color = "black", fill = "lightblue") +
  labs(x = "Enrichment Ratio", y = "Frequency") +
  ggtitle("Histogram of the enrichment ratio of peptides with stop codons for enrichment < 1.25")
```


```{r echo=FALSE}
ggplot(induced_set_stops %>%
         filter(enrichment_ratio_log > 0.5), aes(enrichment_ratio_log)) +
  geom_histogram(bins = 10, color = "black", fill = "lightblue") +
  labs(x = "Log(Enrichment Ratio)", y = "Frequency") +
  ggtitle("Histogram of the enrichment ratio of peptides with stop codons for log(enrichment) > 0.5")
```

The general patterns of stop codon containing peptides is similar to the overall pattern, which kind of sucks. `r induced_set_stops %>% filter(enrichment_ratio > 2) %>% nrow()` (`r (induced_set_stops %>% filter(enrichment_ratio > 2) %>% nrow() / nrow(induced_set_stops) * 100) %>% round(digits = 2)`%) have an enrichment ratio of over 2. This is almost exactly the same as those without stop codons. 




```{r echo=FALSE}

```




