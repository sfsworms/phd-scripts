---
title: "Analysis of short cyclic peptides"
author: "Sebastian Worms"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = '', fig.width = 6, fig.height = 6)

library(tidyverse)
library(knitr)
library(ggplot2)

#Load some custom functions
source("../functions/function_analysis.R")

#Work with a limited number of reads to get something I can work with easily.

n = 5*10^9
```

# Introduction

This is the analysis of the peptides from the drift experiment, looking the the induced, NNK8 file, the only one that showed correlation between synonymous sequence. The required datasets were created in the "peptide_analysis.R" file. I'm going to do it on a subset of of `r print(n_reads)` reads for now. The encoding of enrichment ratio is 'NA' in cases where no reads were present in the first generation and some in the fifth (giving an 'infinite' enrichment ratio).

```{r 'load datasets', echo=FALSE}
directory <- "C:/Users/worms/ngs_data/2022_06_07_drift_seq/90-666155004b/00_fastq/all_files"

# Read a sample of the set
count_set <- read.csv2(file = file.path(directory, "count_set_long.csv"))

# Take only NNK, induced peptides

count_set <- count_set %>%
  filter(library == "nnk" & condition == "induced")

# Going to drop all the infinite enrichment ratio to NA
count_set <- count_set %>%
  mutate(enrichment_ratio = ifelse(is.infinite(enrichment_ratio),NA,enrichment_ratio)) 

# Drop the ones with sequences that don't fit
count_set <- count_set %>%
  filter(grepl("^TGC([ATGC][ATGC][GT]){7}$", seq)) 
```

## Sequence quality and reads distribution

```{r 'sequence_quality'}
unique_seq <- count_set %>%
  pull(seq) %>%
  unique() %>% 
  length()

total_count <- count_set %>% select(gen1,gen5) %>% sum()

unique_peptide <- count_set %>%
  pull(standard_seq) %>%
  unique() %>% 
  length()

```

The data set contains ``r unique_seq` different DNA sequences, sequenced with `r total_count` reads. As expected the size of the library and sequencing means most sequences are sequenced a few times only, with few sequences vastly over represented (hundreds, or in very rare case over a thousand reads), either due to selection directly or potentially quality issues in the randomization of the primers. 

```{r}
table_gen1 <- count_set %>% select(gen1) %>% summary() %>% data.frame()
table_gen5 <- count_set %>% select(gen5) %>% summary() %>% data.frame()
kable(table_gen1 , caption = "Distribution of reads in the first generation")
```

After five days of drift, the distribution is very skewed: most sequences aren't detected at all and have been purged. A small fraction of the sequences have been highly enriched with counts in the thousands of even hundreds of thousands. 

A cursory glance shows that those sequences that were enriched have high counts even at gen1, compatible with the selection theory of initial imbalance in ratios. Let's have a closer look at that.

### Are common sequences in gen1 more likely to be selected?

I would like to investigate whether the sequences with a higher counts in the first generation tends have a higher ratio. One issue to be taken is sequences that aren't present in both generation of the drift as by disappearing they could skew my ratios. 

```{r }
plot_init <- ggplot(count_set %>% filter(gen1 > 0 & gen5 > 0), aes(y = gen1, x = enrichment_ratio_log)) +
  geom_point(alpha = 0.05)

plot_hist <- ggplot(count_set, aes(x = enrichment_ratio_log)) +
  geom_histogram()

plot_init %>% 
  print %>%
  suppressWarnings()


plot_hist %>% 
  print %>%
  suppressWarnings()
```

If anything, the opposite is observed: sequences with a higher count in gen 1 have a lower enrichment ratio. The line appearance is likely due to the ratios you observe with 1 or 2 reads in gen5. That's slightly artefactual though. What's interesting is that a lot of the more highly enriched sequence also have gen1 counts. So that's compatible with the theory that they're pre-selected, even if most common gen1 sequences are common for random reasons and have negative fitness.

```{r 'Adding a number of seq'}

count_set <- count_set %>%
  group_by(standard_seq) %>%
  mutate(homonym_seq = n()) %>%
  ungroup()
```

